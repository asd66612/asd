name: WireGuard workflow
on:
  push:
    branches: [ main ]

jobs:
  setup-wireguard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup WireGuard
        uses: wenoa/setup-wireguard@v1.0.0
        with:
          WG_CONFIG: |
            [Interface]
            Address = 10.0.0.1/24
            ListenPort = 51820
            PrivateKey = QDd26eOReGgnvQwV5VrtFCHkReBdoSmnT0OGp0MbP0M=
            MTU = 1420
            PostUp = sysctl -w net.ipv4.ip_forward=1; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
            PostDown = iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; sysctl -w net.ipv4.ip_forward=0

            [Peer]
            PublicKey = ucAcOYWV4Nf3/7tjDmpdJwnLiRdn8zFwmlRDxrWSJAo=
            AllowedIPs = 10.0.0.2/32

      - name: Show public IP
        run: |
          curl -s https://ipinfo.io/ip

      - name: Show server public key
        run: |
          # 使用 printf 避免尾部换行，tr 去掉 CRLF（Windows 回车），再生成公钥
          printf '%s' "${{ secrets.SERVER_PRIVATE_KEY }}" | tr -d '\r' | wg pubkey
