name: WireGuard workflow (diagnostics)
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  setup-wireguard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup WireGuard
        uses: wenoa/setup-wireguard@v1.0.0
        with:
          WG_CONFIG: |
            [Interface]
            Address = 10.0.0.1/24
            ListenPort = 51820
            PrivateKey = sKhWdUe9a8oE938uUCnHD0sE9n8rtLWpxx6BWQTKIHw=
            MTU = 1420
            PostUp = sysctl -w net.ipv4.ip_forward=1; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
            PostDown = iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; sysctl -w net.ipv4.ip_forward=0

            [Peer]
            PublicKey = 4qdIgJdpEoRbC/XvNo28uhhg2cO0KWMac4JlIlZrN08=
            AllowedIPs = 10.0.0.2/32

      - name: Wait a moment for interface to come up
        run: |
          sleep 2

      - name: Diagnostics - public IP, server pubkey, wg and networking state
        run: |
          echo "===== Public IP (from runner) ====="
          curl -s https://ipinfo.io/ip || echo "(failed to fetch public IP)"

          echo
          echo "===== Server public key (derived from SERVER_PRIVATE_KEY) ====="
          # derive and print public key only (do not print private key)
          printf '%s' "${{ secrets.SERVER_PRIVATE_KEY }}" | tr -d '\r' | wg pubkey || echo "(failed to derive pubkey)"

          echo
          echo "===== wg show ====="
          sudo wg show || echo "(wg show failed)"

          echo
          echo "===== UDP listeners (ss -u -ln) ====="
          sudo ss -u -ln || sudo netstat -anu || echo "(failed to list UDP listeners)"

          echo
          echo "===== iptables NAT rules (nat table) ====="
          sudo iptables -t nat -L -n -v || echo "(iptables nat list failed)"

          echo
          echo "===== ip addr show wg0 ====="
          ip addr show wg0 || echo "(wg0 not present)"

          echo
          echo "===== End of diagnostics ====="
